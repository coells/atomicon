(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const f=9,T=4,k=61,P=7,p=P,b=-1,N=-2,R=5,A=5,Y=[[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]];function H(c){return`${c.row},${c.col}`}function x(c){if(c.row<0||c.row>=f||c.col<0||c.col>=f)return!1;const t=c.col-T,e=c.row-T,s=-t-e;return Math.max(Math.abs(t),Math.abs(e),Math.abs(s))<=T}function M(){const c=[];for(let t=0;t<f;t++)for(let e=0;e<f;e++){const s={row:t,col:e};x(s)&&c.push(s)}return c}function L(){const c=[];for(let t=0;t<f;t++){c[t]=[];for(let e=0;e<f;e++){const s={row:t,col:e};c[t][e]={color:x(s)?b:N}}}return c}function D(c,t){return x(t)&&c[t.row][t.col].color===b}function z(c){const t=[];for(const e of M())c[e.row][e.col].color===b&&t.push(e);return t}function B(c){let t=0;for(const e of M())c[e.row][e.col].color>=0&&t++;return t}function U(c){return Math.min(.12,.03+c*.0015)}function W(c){return Math.random()<U(c)?p:Math.floor(Math.random()*P)}function C(c,t){return Array.from({length:c},()=>W(t))}function O(c,t){return c<10&&t<.58?3:c<25&&t<.82?4:5}function F(c,t){const e=z(c),s=[];for(let n=0;n<t.length&&e.length>0;n++){const o=Math.floor(Math.random()*e.length),r=e.splice(o,1)[0];c[r.row][r.col].color=t[n],s.push(r)}return s}function I(c){const t=[];for(const[e,s]of Y){const n={row:c.row+s,col:c.col+e};x(n)&&t.push(n)}return t}function X(){return Array.from({length:f},()=>Array(f).fill(!1))}function j(c,t,e){if(!x(t)||!x(e))return null;if(t.row===e.row&&t.col===e.col)return[];if(!D(c,e))return null;const s=Array.from({length:f},()=>Array(f).fill(!1)),n=Array.from({length:f},()=>Array(f).fill(null)),o=[t];for(s[t.row][t.col]=!0;o.length>0;){const r=o.shift();for(const i of I(r))if(!(s[i.row][i.col]||!(i.row===t.row&&i.col===t.col)&&c[i.row][i.col].color!==b)){if(s[i.row][i.col]=!0,n[i.row][i.col]=r,i.row===e.row&&i.col===e.col){const l=[];let h=e;for(;h&&!(h.row===t.row&&h.col===t.col);)l.push(h),h=n[h.row][h.col];return l.reverse()}o.push(i)}}return null}function J(c,t,e,s){const n=[];let o=0;const r=[t];for(s[t.row][t.col]=!0;r.length>0;){const i=r.shift(),a=c[i.row][i.col].color;n.push(i),a===e&&o++;for(const l of I(i)){if(s[l.row][l.col])continue;const h=c[l.row][l.col].color;h!==e&&h!==p||(s[l.row][l.col]=!0,r.push(l))}}return{group:n,baseCount:o}}function V(c){const t=new Set;let e=0;const s=Array.from({length:P},()=>X());for(const l of M()){const h=c[l.row][l.col].color;if(h<0||h===p)continue;const d=h,m=s[d];if(m[l.row][l.col])continue;const{group:u,baseCount:y}=J(c,l,d,m);if(u.length>=R&&y>0){let g=!1;for(const w of u){const S=H(w);t.has(S)||(t.add(S),g=!0)}g&&e++}}let n=0;for(const l of t){const[h,d]=l.split(",").map(Number);c[h][d].color===p&&n++}const o=t.size*2,r=Math.max(0,t.size-R)*2,i=e>1?(e-1)*6:0,a=n*2;return{toRemove:t,score:t.size>0?o+r+i+a:0,lineCount:e,jokerRemoved:n}}function Z(c,t){for(const e of t){const[s,n]=e.split(",").map(Number);c[s][n].color=b}}function q(c){return z(c).length===0}function G(c){for(const t of M())if(!(c[t.row][t.col].color<0)){for(const e of I(t))if(c[e.row][e.col].color===b)return!0}return!1}const Q=Math.sqrt(3),tt=30,v=[{core:"#ff6b8a",glow:"rgba(255,107,138,0.38)",membrane:"#ff96ad",nucleus:"#cc3a5c"},{core:"#6be0ff",glow:"rgba(107,224,255,0.38)",membrane:"#91ebff",nucleus:"#2ab0d4"},{core:"#7fefce",glow:"rgba(127,239,206,0.38)",membrane:"#a9f7df",nucleus:"#38bf98"},{core:"#ffbe5c",glow:"rgba(255,190,92,0.38)",membrane:"#ffd38b",nucleus:"#d18f30"},{core:"#c785ff",glow:"rgba(199,133,255,0.38)",membrane:"#dcb0ff",nucleus:"#9640e0"},{core:"#ff85c0",glow:"rgba(255,133,192,0.38)",membrane:"#ffb2d9",nucleus:"#d44a90"},{core:"#85c0ff",glow:"rgba(133,192,255,0.38)",membrane:"#aed8ff",nucleus:"#4a7fc4"}],_={core:"#ffd86b",glow:"rgba(255,216,107,0.45)",membrane:"#ffe59e",nucleus:"#d6a72f"},E=[{eyeScale:1,eyeY:-.16,eyeTilt:-.06,mouth:"smile",blush:!0},{eyeScale:.88,eyeY:-.13,eyeTilt:0,mouth:"o"},{eyeScale:1.05,eyeY:-.15,eyeTilt:.05,mouth:"happy",blush:!0},{eyeScale:.92,eyeY:-.14,eyeTilt:.03,mouth:"grin"},{eyeScale:.85,eyeY:-.16,eyeTilt:-.04,mouth:"wink",blush:!0},{eyeScale:1,eyeY:-.12,eyeTilt:.02,mouth:"cheeky"},{eyeScale:1.08,eyeY:-.13,eyeTilt:.01,mouth:"flat"}];class et{constructor(t){this.centers=new Map,this.hexRadius=20,this.boardSize=0,this.animFrame=0,this.selectedPos=null,this.selectedBounce=0,this.pathAnim=null,this.spawnAnim=null,this.removeAnim=null,this.onAnimationComplete=null,this.canvas=t,this.ctx=t.getContext("2d"),this.validPositions=M(),this.resize()}posKey(t){return`${t.row},${t.col}`}axial(t){return{q:t.col-T,r:t.row-T}}unitCenter(t){const{q:e,r:s}=this.axial(t);return{x:Q*(e+s/2),y:1.5*s}}resize(){const t=window.devicePixelRatio||1,e=Math.min(window.innerWidth-32,window.innerHeight-190,760);this.boardSize=e,this.canvas.style.width=`${e}px`,this.canvas.style.height=`${e}px`,this.canvas.width=e*t,this.canvas.height=e*t,this.ctx.setTransform(t,0,0,t,0,0);let s=1/0,n=-1/0,o=1/0,r=-1/0;for(const m of this.validPositions){const u=this.unitCenter(m);s=Math.min(s,u.x),n=Math.max(n,u.x),o=Math.min(o,u.y),r=Math.max(r,u.y)}const i=e-tt*2;this.hexRadius=Math.min(i/(n-s+2.2),i/(r-o+2.2));const a=e/2,l=e/2,h=(s+n)/2,d=(o+r)/2;this.centers.clear();for(const m of this.validPositions){const u=this.unitCenter(m),y=a+(u.x-h)*this.hexRadius,g=l+(u.y-d)*this.hexRadius;this.centers.set(this.posKey(m),{x:y,y:g})}}getCellFromPixel(t,e){for(const s of this.validPositions){const n=this.centers.get(this.posKey(s));if(n&&this.pointInHex(t,e,n.x,n.y,this.hexRadius*.96))return s}return null}pointInHex(t,e,s,n,o){const r=this.hexPoints(s,n,o);let i=!1;for(let a=0,l=r.length-1;a<r.length;l=a++){const h=r[a].x,d=r[a].y,m=r[l].x,u=r[l].y;d>e!=u>e&&t<(m-h)*(e-d)/(u-d)+h&&(i=!i)}return i}hexPoints(t,e,s){const n=[];for(let o=0;o<6;o++){const r=(60*o-30)*Math.PI/180;n.push({x:t+s*Math.cos(r),y:e+s*Math.sin(r)})}return n}drawHex(t,e,s){const n=this.hexPoints(t,e,s);this.ctx.beginPath(),this.ctx.moveTo(n[0].x,n[0].y);for(let o=1;o<n.length;o++)this.ctx.lineTo(n[o].x,n[o].y);this.ctx.closePath()}setSelected(t){this.selectedPos=t,this.selectedBounce=0}startPathAnimation(t,e){this.pathAnim={path:t,progress:0,color:e}}startSpawnAnimation(t){this.spawnAnim={positions:t,progress:0}}startRemoveAnimation(t){this.removeAnim={positions:t,progress:0}}isAnimating(){return!!(this.pathAnim||this.spawnAnim||this.removeAnim)}draw(t){this.animFrame++;const e=this.ctx,s=e.createRadialGradient(this.boardSize*.5,this.boardSize*.45,20,this.boardSize*.5,this.boardSize*.5,this.boardSize*.7);s.addColorStop(0,"#132235"),s.addColorStop(.65,"#0f1728"),s.addColorStop(1,"#090d18"),e.fillStyle=s,e.fillRect(0,0,this.boardSize,this.boardSize),this.drawSceneParticles();const n=Math.sin(this.animFrame*.015)*.05+1;for(const o of this.validPositions){const r=this.centers.get(this.posKey(o));if(!r)continue;this.drawHex(r.x,r.y,this.hexRadius*.92),e.fillStyle="rgba(13, 24, 41, 0.86)",e.fill(),e.strokeStyle="rgba(145, 176, 220, 0.09)",e.lineWidth=1,e.stroke(),this.drawHex(r.x,r.y,this.hexRadius*.5*n),e.strokeStyle="rgba(95, 130, 180, 0.06)",e.lineWidth=.7,e.stroke();const i=t[o.row][o.col].color;if(i===b)continue;const a=this.posKey(o);if(this.removeAnim&&this.removeAnim.positions.has(a)){this.drawMicroCell(r.x,r.y,i,1-this.removeAnim.progress,1+this.removeAnim.progress*.4);continue}if(this.pathAnim){const d=this.pathAnim.path[this.pathAnim.path.length-1];if(d&&d.row===o.row&&d.col===o.col)continue}if(this.spawnAnim&&this.spawnAnim.positions.some(d=>d.row===o.row&&d.col===o.col)){this.drawMicroCell(r.x,r.y,i,this.spawnAnim.progress,this.spawnAnim.progress);continue}const l=this.selectedPos?.row===o.row&&this.selectedPos?.col===o.col,h=l?Math.sin(this.selectedBounce)*.08:0;this.drawMicroCell(r.x,r.y,i,1,1+h,l)}if(this.pathAnim&&this.pathAnim.path.length>0){const o=this.interpolatedPathPosition(this.pathAnim.path,this.pathAnim.progress);this.drawMicroCell(o.x,o.y,this.pathAnim.color,1,1,!0),this.drawPathTrail(this.pathAnim.path,this.pathAnim.progress)}this.updateAnimations(),this.selectedBounce+=.14}drawSceneParticles(){const t=this.ctx,e=this.animFrame*.01,s=28;for(let n=0;n<s;n++){const o=(n*139+e*240)%(this.boardSize+90)-45,r=(n*83+e*120+Math.sin(n*1.3+e*2)*28)%(this.boardSize+90)-45,i=1.8+n%4*.8,a=t.createRadialGradient(o,r,0,o,r,i*3);a.addColorStop(0,"rgba(174, 219, 255, 0.5)"),a.addColorStop(1,"rgba(174, 219, 255, 0)"),t.fillStyle=a,t.beginPath(),t.arc(o,r,i*3,0,Math.PI*2),t.fill()}}interpolatedPathPosition(t,e){if(t.length===1)return this.centers.get(this.posKey(t[0]));const s=t.length-1,n=e*s,o=Math.min(Math.floor(n),s-1),r=Math.max(0,Math.min(1,n-o)),i=this.centers.get(this.posKey(t[o])),a=this.centers.get(this.posKey(t[o+1]));return{x:i.x+(a.x-i.x)*r,y:i.y+(a.y-i.y)*r}}drawPathTrail(t,e){if(t.length<2)return;const s=this.ctx,n=t.length-1,o=e*n,r=Math.max(1,Math.ceil(o));s.beginPath();const i=this.centers.get(this.posKey(t[0]));s.moveTo(i.x,i.y);for(let a=1;a<=r&&a<t.length;a++){const l=this.centers.get(this.posKey(t[a]));s.lineTo(l.x,l.y)}s.strokeStyle="rgba(145, 220, 255, 0.35)",s.lineWidth=2.2,s.shadowBlur=12,s.shadowColor="rgba(145, 220, 255, 0.6)",s.stroke(),s.shadowBlur=0}updateAnimations(){let t=!1;if(this.pathAnim){const e=Math.max(1,this.pathAnim.path.length-1);this.pathAnim.progress+=Math.min(.11,.68/e),this.pathAnim.progress>=1&&(this.pathAnim=null,t=!0)}this.spawnAnim&&(this.spawnAnim.progress+=.075,this.spawnAnim.progress>=1&&(this.spawnAnim=null,t=!0)),this.removeAnim&&(this.removeAnim.progress+=.068,this.removeAnim.progress>=1&&(this.removeAnim=null,t=!0)),t&&!this.isAnimating()&&this.onAnimationComplete&&this.onAnimationComplete()}drawMicroCell(t,e,s,n,o,r=!1){const i=this.ctx,a=this.hexRadius*.52*o,l=s===p?_:v[s%v.length],h=this.animFrame*.04;i.save(),i.globalAlpha=n;const d=Math.sin(h+(t+e)*.01)*a*.03;e+=d;const m=i.createRadialGradient(t,e,a*.25,t,e,a*1.8);m.addColorStop(0,l.glow),m.addColorStop(1,"transparent"),i.fillStyle=m,i.beginPath(),i.arc(t,e,a*1.8,0,Math.PI*2),i.fill(),r&&(i.strokeStyle=l.core,i.lineWidth=2,i.shadowColor=l.core,i.shadowBlur=14,i.beginPath(),i.arc(t,e,a+5,0,Math.PI*2),i.stroke(),i.shadowBlur=0);const u=i.createRadialGradient(t-a*.25,e-a*.25,a*.2,t,e,a);u.addColorStop(0,l.membrane),u.addColorStop(.72,l.core),u.addColorStop(1,l.nucleus),i.fillStyle=u,i.beginPath(),i.arc(t,e,a,0,Math.PI*2),i.fill();const y=this.animFrame*.022;i.globalAlpha=n*.35;for(let w=0;w<3;w++){const S=y+w*Math.PI*2/3,K=t+Math.cos(S)*a*.35,$=e+Math.sin(S)*a*.35;i.fillStyle=l.nucleus,i.beginPath(),i.arc(K,$,a*.14,0,Math.PI*2),i.fill()}i.globalAlpha=n*.78;const g=i.createRadialGradient(t-a*.25,e-a*.26,0,t,e,a*.9);g.addColorStop(0,"rgba(255,255,255,0.66)"),g.addColorStop(1,"transparent"),i.fillStyle=g,i.beginPath(),i.arc(t,e,a,0,Math.PI*2),i.fill(),s===p?(this.drawJokerSymbol(t,e,a*.52,n),this.drawFace(t,e,a*.86,E[0],h,!0)):this.drawFace(t,e,a*.9,E[s%E.length],h),i.restore()}drawFace(t,e,s,n,o,r=!1){const i=this.ctx,a=Math.sin(o*.35+t*.04+e*.03)>.92?.2:1,l=e+s*n.eyeY,h=s*.28,d=s*.12*n.eyeScale,m=s*.16*a;n.blush&&(i.fillStyle="rgba(255,190,205,0.25)",i.beginPath(),i.ellipse(t-s*.38,e+s*.07,s*.12,s*.07,0,0,Math.PI*2),i.ellipse(t+s*.38,e+s*.07,s*.12,s*.07,0,0,Math.PI*2),i.fill()),i.save(),i.translate(t-h,l),i.rotate(n.eyeTilt),i.fillStyle="rgba(17, 24, 37, 0.85)",i.beginPath(),i.ellipse(0,0,d,m,0,0,Math.PI*2),i.fill(),i.restore(),n.mouth!=="wink"?(i.save(),i.translate(t+h,l),i.rotate(-n.eyeTilt),i.fillStyle="rgba(17, 24, 37, 0.85)",i.beginPath(),i.ellipse(0,0,d,m,0,0,Math.PI*2),i.fill(),i.restore()):(i.strokeStyle="rgba(17, 24, 37, 0.85)",i.lineWidth=s*.07,i.lineCap="round",i.beginPath(),i.moveTo(t+h-s*.08,l),i.lineTo(t+h+s*.08,l),i.stroke()),i.strokeStyle=r?"rgba(77, 39, 0, 0.8)":"rgba(30, 39, 58, 0.82)",i.fillStyle=r?"rgba(255, 227, 156, 0.85)":"rgba(236, 245, 255, 0.6)",i.lineWidth=s*.06;const u=e+s*.2;switch(n.mouth){case"smile":case"happy":i.beginPath(),i.arc(t,u-s*.04,s*(n.mouth==="happy"?.22:.18),.2,Math.PI-.2),i.stroke();break;case"grin":i.beginPath(),i.arc(t,u-s*.03,s*.19,.15,Math.PI-.15),i.stroke(),i.beginPath(),i.moveTo(t-s*.12,u+s*.05),i.lineTo(t+s*.12,u+s*.05),i.stroke();break;case"flat":i.beginPath(),i.moveTo(t-s*.16,u+s*.02),i.lineTo(t+s*.16,u+s*.02),i.stroke();break;case"o":i.beginPath(),i.ellipse(t,u,s*.09,s*.11,0,0,Math.PI*2),i.stroke();break;case"cheeky":i.beginPath(),i.arc(t-s*.03,u-s*.02,s*.16,.1,Math.PI-.5),i.stroke(),i.beginPath(),i.ellipse(t+s*.12,u+s*.03,s*.05,s*.08,0,0,Math.PI*2),i.fill();break;default:i.beginPath(),i.arc(t,u,s*.17,.2,Math.PI-.2),i.stroke();break}}drawJokerSymbol(t,e,s,n){const o=this.ctx,r=this.animFrame*.015;o.save(),o.globalAlpha=n,o.translate(t,e),o.rotate(r),o.strokeStyle="rgba(255,255,255,0.9)",o.lineWidth=1.6,o.beginPath();for(let i=0;i<6;i++){const a=i*Math.PI/3,l=Math.cos(a)*s,h=Math.sin(a)*s;i===0?o.moveTo(l,h):o.lineTo(l,h)}o.closePath(),o.stroke(),o.rotate(-r*1.7),o.strokeStyle="rgba(255,235,170,0.95)",o.beginPath(),o.moveTo(0,-s*.95),o.lineTo(0,s*.95),o.moveTo(-s*.95,0),o.lineTo(s*.95,0),o.stroke(),o.restore()}getThemeColor(t){return t===p?_.core:t<0?"transparent":v[t%v.length].core}getCanvas(){return this.canvas}}class st{constructor(){this.actx=null,this.musicTimer=null,this.musicStep=0,this.songIndex=0,this.sfxEnabled=!0,this.musicEnabled=!0,this.musicTickMs=420,this.songs=[{name:"Gymnopedie Mood",melody:[66,-1,69,-1,71,-1,69,-1,66,-1,64,-1,62,-1,64,-1,66,-1,69,-1,71,-1,73,-1,71,-1,69,-1,66,-1,64,-1,62,-1,64,-1,66,-1,69,-1,71,-1,69,-1,66,-1,64,-1,62,-1,61,-1,62,-1,64,-1,66,-1,64,-1,62,-1,59,-1],bass:[42,-1,-1,-1,49,-1,-1,-1,45,-1,-1,-1,52,-1,-1,-1,42,-1,-1,-1,49,-1,-1,-1,40,-1,-1,-1,47,-1,-1,-1],chordRoots:[54,61,57,64,54,61,52,59]}]}ensure(){return this.actx||(this.actx=new AudioContext),this.actx}async unlock(){const t=this.ensure();t.state==="suspended"&&await t.resume()}setSfxEnabled(t){this.sfxEnabled=t}setMusicEnabled(t){if(this.musicEnabled=t,!t){this.musicTimer!==null&&(window.clearInterval(this.musicTimer),this.musicTimer=null);return}this.startMusic()}getSfxEnabled(){return this.sfxEnabled}getMusicEnabled(){return this.musicEnabled}startMusic(){!this.musicEnabled||this.musicTimer!==null||(this.musicStep=0,this.songIndex=0,this.musicTimer=window.setInterval(()=>{this.musicEnabled&&this.playMusicStep()},this.musicTickMs))}midiToFreq(t){return 440*Math.pow(2,(t-69)/12)}playTone(t,e){const s=this.ensure(),n=s.createOscillator(),o=s.createGain();n.connect(o),o.connect(s.destination),n.type=e.type,n.frequency.value=t,e.detune&&(n.detune.value=e.detune);const r=s.currentTime,i=e.attack??.02,a=e.release??e.duration;o.gain.setValueAtTime(1e-4,r),o.gain.exponentialRampToValueAtTime(e.volume,r+i),o.gain.exponentialRampToValueAtTime(1e-4,r+a),n.start(r),n.stop(r+e.duration)}playMusicStep(){if(this.ensure().state!=="running")return;const e=this.songs[this.songIndex%this.songs.length],s=this.musicStep%e.melody.length,n=e.melody[s];if(n>=0){const o=this.midiToFreq(n);this.playTone(o,{duration:.72,volume:.024,type:"sine",attack:.04,release:.66}),(s%8===0||Math.random()>.9)&&this.playTone(o*2,{duration:.58,volume:.006,type:"sine",attack:.06,release:.54,detune:2})}if(s%2===0){const o=e.bass[s/2%e.bass.length];o>=0&&this.playTone(this.midiToFreq(o),{duration:1.35,volume:.012,type:"triangle",attack:.06,release:1.2})}if(s%4===0){const o=e.chordRoots[s/4%e.chordRoots.length];[o,o+3,o+7,o+10].forEach((i,a)=>{this.playTone(this.midiToFreq(i),{duration:1.68,volume:.007/(a+1),type:"sine",attack:.08,release:1.45,detune:a})})}this.musicStep++}pop(){if(!this.sfxEnabled)return;const t=this.ensure(),e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.type="sine",e.frequency.setValueAtTime(600,t.currentTime),e.frequency.exponentialRampToValueAtTime(1200,t.currentTime+.08),s.gain.setValueAtTime(.15,t.currentTime),s.gain.exponentialRampToValueAtTime(.001,t.currentTime+.15),e.start(t.currentTime),e.stop(t.currentTime+.15)}move(){if(!this.sfxEnabled)return;const t=this.ensure(),e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.type="triangle",e.frequency.setValueAtTime(260,t.currentTime),e.frequency.exponentialRampToValueAtTime(520,t.currentTime+.14),s.gain.setValueAtTime(.08,t.currentTime),s.gain.exponentialRampToValueAtTime(.001,t.currentTime+.18),e.start(t.currentTime),e.stop(t.currentTime+.18)}score(){if(!this.sfxEnabled)return;const t=this.ensure();[523,659,784,1047].forEach((s,n)=>{const o=t.createOscillator(),r=t.createGain();o.connect(r),r.connect(t.destination),o.type="sine",o.frequency.value=s,r.gain.setValueAtTime(.1,t.currentTime+n*.08),r.gain.exponentialRampToValueAtTime(.001,t.currentTime+n*.08+.2),o.start(t.currentTime+n*.08),o.stop(t.currentTime+n*.08+.2)})}combo(){if(!this.sfxEnabled)return;const t=this.ensure();[659,784,988,1318].forEach((s,n)=>{const o=t.createOscillator(),r=t.createGain();o.connect(r),r.connect(t.destination),o.type="sine",o.frequency.value=s,r.gain.setValueAtTime(.12,t.currentTime+n*.05),r.gain.exponentialRampToValueAtTime(.001,t.currentTime+n*.05+.16),o.start(t.currentTime+n*.05),o.stop(t.currentTime+n*.05+.16)})}error(){if(!this.sfxEnabled)return;const t=this.ensure(),e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.type="square",e.frequency.setValueAtTime(200,t.currentTime),e.frequency.exponentialRampToValueAtTime(100,t.currentTime+.15),s.gain.setValueAtTime(.08,t.currentTime),s.gain.exponentialRampToValueAtTime(.001,t.currentTime+.2),e.start(t.currentTime),e.stop(t.currentTime+.2)}gameOver(){if(!this.sfxEnabled)return;const t=this.ensure();[400,350,300,200].forEach((s,n)=>{const o=t.createOscillator(),r=t.createGain();o.connect(r),r.connect(t.destination),o.type="sine",o.frequency.value=s,r.gain.setValueAtTime(.12,t.currentTime+n*.15),r.gain.exponentialRampToValueAtTime(.001,t.currentTime+n*.15+.3),o.start(t.currentTime+n*.15),o.stop(t.currentTime+n*.15+.3)})}}class it{constructor(){this.sfx=new st,this.phase=0,this.selected=null,this.score=0,this.combo=0,this.moveCount=0,this.nextColors=[],this.pendingRemove=null,this.pendingLineScore=0,this.pendingLineCount=0,this.leaderboardKey="atomicon_leaderboard",this.loop=()=>{this.renderer.draw(this.grid),requestAnimationFrame(this.loop)};const t=document.getElementById("game-canvas");this.renderer=new et(t),this.grid=L(),this.scoreEl=document.getElementById("score"),this.bestEl=document.getElementById("best"),this.messageEl=document.getElementById("message"),this.overlay=document.getElementById("overlay"),this.finalScoreEl=document.getElementById("final-score"),this.leaderboardEl=document.getElementById("leaderboard"),this.toggleSfxBtn=document.getElementById("toggle-sfx-btn"),this.toggleMusicBtn=document.getElementById("toggle-music-btn"),this.nextDots=[];for(let n=0;n<A;n++){const o=document.getElementById(`next${n}`);o&&this.nextDots.push(o)}this.difficultyEl=document.getElementById("difficulty"),this.comboEl=document.getElementById("combo");const e=localStorage.getItem("atomicon_sfx"),s=localStorage.getItem("atomicon_music");this.sfx.setSfxEnabled(e!=="off"),this.sfx.setMusicEnabled(s!=="off"),this.best=parseInt(localStorage.getItem("atomicon_best")||"0",10),this.bestEl.textContent=String(this.best),t.addEventListener("click",n=>this.handleClick(n)),document.getElementById("new-game-btn").addEventListener("click",()=>this.newGame()),document.getElementById("play-again-btn").addEventListener("click",()=>this.newGame()),this.toggleSfxBtn.addEventListener("click",()=>this.toggleSfx()),this.toggleMusicBtn.addEventListener("click",()=>this.toggleMusic()),window.addEventListener("keydown",n=>this.handleHotkeys(n)),window.addEventListener("resize",()=>{this.renderer.resize()}),this.renderer.onAnimationComplete=()=>this.onAnimComplete(),this.newGame(),this.loop(),this.syncAudioButtons(),this.renderLeaderboard(),this.sfx.unlock().then(()=>this.sfx.startMusic())}handleHotkeys(t){t.key.toLowerCase()==="m"&&this.toggleMusic(),t.key.toLowerCase()==="s"&&this.toggleSfx()}toggleSfx(){this.sfx.setSfxEnabled(!this.sfx.getSfxEnabled()),localStorage.setItem("atomicon_sfx",this.sfx.getSfxEnabled()?"on":"off"),this.syncAudioButtons()}toggleMusic(){const t=!this.sfx.getMusicEnabled();this.sfx.setMusicEnabled(t),localStorage.setItem("atomicon_music",t?"on":"off"),this.syncAudioButtons(),t&&this.sfx.unlock().then(()=>this.sfx.startMusic())}syncAudioButtons(){this.toggleSfxBtn.textContent=`SFX: ${this.sfx.getSfxEnabled()?"ON":"OFF"}`,this.toggleMusicBtn.textContent=`Music: ${this.sfx.getMusicEnabled()?"ON":"OFF"}`,this.toggleSfxBtn.classList.toggle("off",!this.sfx.getSfxEnabled()),this.toggleMusicBtn.classList.toggle("off",!this.sfx.getMusicEnabled())}getLeaderboard(){const t=localStorage.getItem(this.leaderboardKey);if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e.map(s=>Number(s)).filter(s=>Number.isFinite(s)&&s>=0).sort((s,n)=>n-s).slice(0,5):[]}catch{return[]}}storeLeaderboard(t){localStorage.setItem(this.leaderboardKey,JSON.stringify(t.slice(0,5)))}submitLeaderboard(t){const e=this.getLeaderboard();e.push(t),e.sort((s,n)=>n-s),this.storeLeaderboard(e.slice(0,5)),this.renderLeaderboard()}renderLeaderboard(){const t=this.getLeaderboard(),e=Array.from({length:5},(s,n)=>{const o=t[n]??0;return`<li><span>#${n+1}</span><strong>${o}</strong></li>`});this.leaderboardEl.innerHTML=e.join("")}newGame(){this.grid=L(),this.score=0,this.combo=0,this.moveCount=0,this.selected=null,this.pendingRemove=null,this.pendingLineScore=0,this.pendingLineCount=0,this.phase=0,this.overlay.classList.remove("visible"),this.renderer.setSelected(null),this.nextColors=C(A,this.moveCount),F(this.grid,C(6,this.moveCount)),this.updateUI(),this.setMessage("Select a cell to move")}updateUI(){this.scoreEl.textContent=String(this.score),this.bestEl.textContent=String(this.best),this.comboEl.textContent=this.combo>1?`x${this.combo}`:"-";const t=B(this.grid),e=O(this.moveCount,t/k);this.difficultyEl.textContent=`${e} / turn`;for(let s=0;s<this.nextDots.length;s++){const n=this.nextColors[s];this.nextDots[s].style.background=n!==void 0?this.renderer.getThemeColor(n):"transparent",this.nextDots[s].style.opacity=s<e?"1":"0.42"}}setMessage(t){this.messageEl.textContent=t}handleClick(t){if(this.phase!==0)return;this.sfx.unlock().then(()=>this.sfx.startMusic());const e=this.renderer.getCanvas().getBoundingClientRect(),s=t.clientX-e.left,n=t.clientY-e.top,o=this.renderer.getCellFromPixel(s,n);if(!o)return;const r=this.grid[o.row][o.col].color;if(this.selected===null)r>=0&&(this.selected=o,this.renderer.setSelected(o),this.sfx.pop(),this.setMessage("Select destination"));else{if(r>=0){this.selected=o,this.renderer.setSelected(o),this.sfx.pop(),this.setMessage("Select destination");return}const i=j(this.grid,this.selected,o);if(!i||i.length===0){this.sfx.error(),this.setMessage("No path! Try another cell");return}this.phase=1;const a=this.grid[this.selected.row][this.selected.col].color;this.grid[this.selected.row][this.selected.col].color=-1,this.grid[o.row][o.col].color=a;const l=[this.selected,...i];this.renderer.setSelected(null),this.renderer.startPathAnimation(l,a),this.sfx.move(),this.selected=null,this.setMessage("")}}onAnimComplete(){if(this.phase===1){this.moveCount++;const{toRemove:t,score:e,lineCount:s}=V(this.grid);if(t.size>0){this.combo++;const n=this.combo>1?Math.floor(e*.2*(this.combo-1)):0,o=e+n;this.score+=o,this.score>this.best&&(this.best=this.score,localStorage.setItem("atomicon_best",String(this.best))),this.pendingRemove=t,this.pendingLineScore=o,this.pendingLineCount=s,this.phase=2,this.renderer.startRemoveAnimation(t),this.combo>1?(this.sfx.combo(),this.setMessage(`Combo x${this.combo}! +${o}`)):(this.sfx.score(),this.setMessage(`+${o} points`)),this.updateUI();return}this.combo=0,this.spawnPhase();return}if(this.phase===2){if(this.pendingRemove&&Z(this.grid,this.pendingRemove),this.pendingRemove=null,this.pendingLineScore=0,this.pendingLineCount=0,!G(this.grid)||q(this.grid)){this.gameOver();return}this.phase=0,this.setMessage("Select a cell to move"),this.updateUI();return}if(this.phase===3){const{toRemove:t,score:e}=V(this.grid);if(t.size>0){this.combo++;const s=this.combo>1?Math.floor(e*.2*(this.combo-1)):0,n=e+s;this.score+=n,this.score>this.best&&(this.best=this.score,localStorage.setItem("atomicon_best",String(this.best))),this.pendingRemove=t,this.phase=2,this.renderer.startRemoveAnimation(t),this.combo>1?(this.sfx.combo(),this.setMessage(`Chain combo x${this.combo}! +${n}`)):(this.sfx.score(),this.setMessage(`+${n} points`)),this.updateUI();return}if(this.combo=0,q(this.grid)||!G(this.grid)){this.gameOver();return}this.phase=0,this.setMessage("Select a cell to move"),this.updateUI();return}}spawnPhase(){const t=B(this.grid)/k,e=O(this.moveCount,t),s=this.nextColors.slice(0,e),n=F(this.grid,s);this.nextColors=C(A,this.moveCount),this.updateUI(),n.length>0?(this.phase=3,this.renderer.startSpawnAnimation(n),this.setMessage(`Spawned ${n.length} cells`)):this.gameOver()}gameOver(){this.phase=4,this.sfx.gameOver(),this.submitLeaderboard(this.score),this.finalScoreEl.textContent=String(this.score),this.overlay.classList.add("visible"),this.setMessage("Game Over")}}new it;
